
/**
 * @file range.c
 * @brief Range app for C3 UI
 * Generated by app_create.py
 */

#include "range.h"

#ifdef ENABLE_APP_RANGE

/* Replace NULL with your app icon eg &range_icon */
REGISTER_APP("Range", NULL, range_screen_main, range_screen_init);

static lv_obj_t *ui_arcprogress;
static lv_obj_t *ui_percentlabel;
static lv_obj_t *ui_valuelabel;
static int32_t current_pos;


static void my_encoder_handler(long pos, int32_t change) {
    // printf("Encoder moved to %ld\n", pos);
    int32_t new_val = pos - current_pos;
    if (new_val < 0){
        current_pos = pos;
    }
    if (new_val > 255){
        current_pos = pos - 255;
    }
    if (new_val >= 0 && new_val <= 255){

        lv_arc_set_value(ui_arcprogress, new_val);
        lv_label_set_text_fmt(ui_valuelabel, "%d", new_val);
        lv_label_set_text_fmt(ui_percentlabel, "%d%%", (int)((new_val * 100 / 255.0)));

        // lv_label_set_text_fmt(ui_valuelabel, "%d + %d", lv_arc_get_value(ui_arcprogress), pos);
        // lv_label_set_text_fmt(ui_percentlabel, "= %d", new_val);
    }

    // lv_label_set_text_fmt(ui_valuelabel, "%d",  pos);
    
    
}

static void my_button_handler(bool pressed) {
    // if (long_press) {
    //     printf("Long button press!\n");
    // } else if (pressed) {
    //     printf("Short button press!\n");
    // }
}

// void ui_event_arcprogress( lv_event_t * e) {
//     int32_t val = lv_arc_get_value(ui_arcprogress);
//     lv_label_set_text_fmt(ui_percentlabel, "%d%%", val);
//     lv_label_set_text_fmt(ui_valuelabel, "%d", val);
// }

void range_screen_event_cb(lv_event_t *e)
{
    lv_event_code_t event_code = lv_event_get_code(e);
    if (event_code == LV_EVENT_SCREEN_LOAD_START)
    {
        /* Do something before the screen is loaded */

        onGameOpened();
    }
    if (event_code == LV_EVENT_SCREEN_LOADED)
    {
        /* Do something after the screen is loaded */
        /* This is a good place to start animations or timers */

        current_pos = read_encoder_position();

        input_bus_add_encoder_sub(my_encoder_handler);
        input_bus_add_button_sub(my_button_handler);
    }
    if (event_code == LV_EVENT_SCREEN_UNLOAD_START)
    {
        /* Do something before the screen is unloaded */
        /* This is a good place to save data or stop timers */

        input_bus_remove_encoder_sub(my_encoder_handler);
        input_bus_remove_button_sub(my_button_handler);
    }
    if (event_code == LV_EVENT_SCREEN_UNLOADED)
    {
        /* Do something after the screen is unloaded */
        /* This is a good place to clean up resources */

        onGameClosed();

        /* Clean and delete screen if needed */
        lv_obj_delete(range_screen_main);
        range_screen_main = NULL;
    }

    if (event_code == LV_EVENT_GESTURE && lv_indev_get_gesture_dir(lv_indev_active()) == LV_DIR_RIGHT)
    {
        ui_app_exit(); /* exit to app list */
        /* Call this function to close the app, you can even use button instead of gesture */
    }
}

void range_screen_init(void)
{
    /* create the screen */
    range_screen_main = lv_obj_create(NULL);
    lv_obj_remove_flag(range_screen_main, LV_OBJ_FLAG_SCROLLABLE);
    lv_obj_set_style_bg_color(range_screen_main, lv_color_hex(0x000000), LV_PART_MAIN | LV_STATE_DEFAULT);
    lv_obj_set_style_bg_opa(range_screen_main, 255, LV_PART_MAIN | LV_STATE_DEFAULT);

    ui_arcprogress = lv_arc_create(range_screen_main);
    lv_obj_set_width( ui_arcprogress, 200);
    lv_obj_set_height( ui_arcprogress, 200);
    lv_obj_set_align( ui_arcprogress, LV_ALIGN_CENTER );
    lv_arc_set_range(ui_arcprogress, 0,255);
    lv_arc_set_value(ui_arcprogress, 100);
    lv_arc_set_bg_angles(ui_arcprogress,0,360);
    lv_arc_set_rotation(ui_arcprogress,270);
    lv_obj_remove_flag(ui_arcprogress, LV_OBJ_FLAG_CLICKABLE);

    ui_valuelabel = lv_label_create(range_screen_main);
    lv_obj_set_x( ui_valuelabel, 0 );
    lv_obj_set_y( ui_valuelabel, -30 );
    lv_obj_set_align( ui_valuelabel, LV_ALIGN_CENTER );
    lv_label_set_text(ui_valuelabel,"50");
    lv_obj_set_style_text_font(ui_valuelabel, &lv_font_montserrat_40, LV_PART_MAIN| LV_STATE_DEFAULT);
    lv_obj_set_style_text_color(ui_valuelabel, lv_color_hex(0x808080), LV_PART_MAIN | LV_STATE_DISABLED );
    lv_obj_set_style_text_opa(ui_valuelabel, 255, LV_PART_MAIN| LV_STATE_DISABLED);

    ui_percentlabel = lv_label_create(range_screen_main);
    lv_obj_set_x( ui_percentlabel, 0 );
    lv_obj_set_y( ui_percentlabel, 30 );
    lv_obj_set_align( ui_percentlabel, LV_ALIGN_CENTER );
    lv_label_set_text(ui_percentlabel,"20%");
    lv_obj_set_style_text_font(ui_percentlabel, &lv_font_montserrat_40, LV_PART_MAIN| LV_STATE_DEFAULT);
    lv_obj_set_style_text_color(ui_percentlabel, lv_color_hex(0x808080), LV_PART_MAIN | LV_STATE_DISABLED );
    lv_obj_set_style_text_opa(ui_percentlabel, 255, LV_PART_MAIN| LV_STATE_DISABLED);

    // lv_obj_add_event_cb(ui_arcprogress, ui_event_arcprogress, LV_EVENT_VALUE_CHANGED, NULL);


    lv_obj_add_event_cb(range_screen_main, range_screen_event_cb, LV_EVENT_ALL, NULL);
}

#endif

